node {

  deleteDir()

  properties([
    parameters([
      string(name: 'target_host', defaultValue: '', description: 'Insert hostname'),
      choice(name: 'env',  choices:'dev\nstage\nprod-ams\nprod-rot', description: 'Select Environment'),
      choice(name: 'sip_service', choices: 'False\nTrue', description: 'Sip interface is present'),
      password(name: 'ansible_sudo_pass', defaultValue: '', description: 'Input passwd for sudo user')
      ])
    ])

  stage 'Checkout'
    checkout([$class: 'GitSCM',
        branches: [[name: '*/master']],
        doGenerateSubmoduleConfigurations: false,
        extensions: [],
        submoduleCfg: []
        // userRemoteConfigs: [[credentialsId: 'jendep', url: 'git@bitbucket.org:kwebbl/playbook-common.git']]
        ])

 stage 'Prepare Ansible Environment'
    sh 'git submodule update --init'
    sh 'git submodule update --remote'
    sh 'ansible-galaxy install -r requirements.yml'

 stage 'Create Inventory'
    sh 'echo -e "[singlehost]\n"$target_host > environments/$env/singlehost'

  stage 'Setting common parameters'
    wrap([$class: 'AnsiColorBuildWrapper', colorMapName: "xterm"]) {
      ansiblePlaybook(
         playbook:    'common.yml',
         inventory:   'environments/$env/singlehost',
         credentialsId: 'sudo_user',
         sudo: true,
         colorized:   true,
         extraVars: [
            ansible_sudo_pass: [value: "$ansible_sudo_pass", hidden: true] ,
            target_host: "$target_host",
            env: "$env"

        ]
      )
    }
}
